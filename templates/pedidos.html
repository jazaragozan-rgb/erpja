{% extends "base.html" %}
{% block title %}· Pedidos{% endblock %}
{% block topbar %}
<div><div class="topbar-title">PEDIDOS A PROVEEDORES</div><div class="topbar-sub">Control de subcontratación</div></div>
<div class="topbar-right">
  <a href="/proveedores" class="btn">Ver proveedores</a>
  <a href="/proyectos" class="btn">Ver proyectos</a>
</div>
{% endblock %}
{% block content %}
<div class="kpi-row">
  <div class="kpi orange"><div class="kpi-label">Total pedidos</div><div class="kpi-value">{{ stats.total }}</div></div>
  <div class="kpi yellow"><div class="kpi-label">Pendientes</div><div class="kpi-value">{{ stats.pendientes }}</div></div>
  <div class="kpi blue"><div class="kpi-label">En producción/tránsito</div><div class="kpi-value">{{ stats.en_produccion + stats.en_transito }}</div></div>
  <div class="kpi green"><div class="kpi-label">Recibidos</div><div class="kpi-value">{{ stats.recibidos }}</div><div class="kpi-sub">{{ "%.0f"|format(stats.importe_pendiente) }}€ en curso</div></div>
</div>

<!-- FILTROS -->
<div class="panel" style="margin-bottom:1.2rem">
  <div class="panel-header"><span class="panel-title">Filtros de búsqueda</span><button class="panel-action" onclick="limpiarFiltros()">Limpiar filtros</button></div>
  <div class="panel-body" style="display:flex;gap:.8rem;flex-wrap:wrap">
    <div style="flex:1;min-width:180px">
      <label style="font-family:var(--mono);font-size:.48rem;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:.3rem">Estado</label>
      <select id="filtro-estado" onchange="aplicarFiltros()" style="background:var(--card);border:1px solid var(--border);color:var(--text);font-size:.75rem;padding:.4rem .6rem;outline:none;width:100%">
        <option value="">Todos los estados</option>
        <option value="pendiente">Pendientes</option>
        <option value="en_produccion">En producción</option>
        <option value="en_transito">En tránsito</option>
        <option value="recibido">Recibidos</option>
        <option value="cancelado">Cancelados</option>
      </select>
    </div>
    <div style="flex:1;min-width:180px">
      <label style="font-family:var(--mono);font-size:.48rem;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:.3rem">Proveedor</label>
      <select id="filtro-proveedor" onchange="aplicarFiltros()" style="background:var(--card);border:1px solid var(--border);color:var(--text);font-size:.75rem;padding:.4rem .6rem;outline:none;width:100%">
        <option value="">Todos los proveedores</option>
        {% for pv in proveedores %}
        <option value="{{ pv.nombre }}">{{ pv.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="flex:1;min-width:180px">
      <label style="font-family:var(--mono);font-size:.48rem;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:.3rem">Cliente</label>
      <select id="filtro-cliente" onchange="aplicarFiltros()" style="background:var(--card);border:1px solid var(--border);color:var(--text);font-size:.75rem;padding:.4rem .6rem;outline:none;width:100%">
        <option value="">Todos los clientes</option>
        {% for c in clientes %}
        <option value="{{ c.nombre }}">{{ c.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="flex:1;min-width:180px">
      <label style="font-family:var(--mono);font-size:.48rem;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:.3rem">Proyecto</label>
      <select id="filtro-proyecto" onchange="aplicarFiltros()" style="background:var(--card);border:1px solid var(--border);color:var(--text);font-size:.75rem;padding:.4rem .6rem;outline:none;width:100%">
        <option value="">Todos los proyectos</option>
        {% for p in proyectos %}
        <option value="{{ p.referencia }}">{{ p.referencia }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
</div>

<!-- TABLA -->
<div class="panel">
  <div class="panel-header">
    <span class="panel-title">Todos los pedidos</span>
    <span id="contador-filtrados" style="font-family:var(--mono);font-size:.52rem;color:var(--muted2)"></span>
  </div>
  <table class="table" id="tabla-pedidos">
    <thead>
      <tr>
        <th>Número</th>
        <th>Proveedor</th>
        <th>Concepto</th>
        <th>Proyecto</th>
        <th>Cliente</th>
        <th>Importe</th>
        <th>F. Pedido</th>
        <th>Entrega esp.</th>
        <th>Estado</th>
        <th>Albarán</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for p in pedidos %}
      <tr data-estado="{{ p.estado }}" data-proveedor="{{ p.proveedor_nombre }}" data-cliente="{{ p.cliente_nombre or '' }}" data-proyecto="{{ p.proyecto_ref or '' }}">
        <td><span style="font-family:var(--mono);font-size:.62rem;color:var(--accent)">{{ p.numero }}</span></td>
        <td>
          <div style="font-size:.8rem">{{ p.proveedor_nombre }}</div>
          {% if p.proveedor_empresa %}<div style="font-size:.7rem;color:var(--muted2)">{{ p.proveedor_empresa }}</div>{% endif %}
        </td>
        <td style="color:var(--muted2);font-size:.78rem;max-width:200px">
          {{ p.concepto[:50] }}{% if p.concepto|length > 50 %}...{% endif %}
        </td>
        <td>
          {% if p.proyecto_ref %}
          <a href="/proyecto/{{ p.proyecto_id }}" style="font-family:var(--mono);font-size:.62rem;color:var(--accent);text-decoration:none">
            {{ p.proyecto_ref }} →
          </a>
          {% else %}
          <span style="color:var(--muted);font-size:.7rem">—</span>
          {% endif %}
        </td>
        <td style="font-size:.78rem;color:var(--muted2)">{{ p.cliente_nombre or '—' }}</td>
        <td style="font-family:var(--mono);font-size:.78rem;color:#fff">{{ "%.2f"|format(p.importe) }}€</td>
        <td style="font-family:var(--mono);font-size:.65rem;color:var(--muted2)">{{ p.fecha_pedido }}</td>
        <td style="font-family:var(--mono);font-size:.65rem;color:var(--muted2)">{{ p.fecha_entrega_esperada or '—' }}</td>
        <td>
          {% if p.estado == 'pendiente' %}<span class="badge badge-muted">Pendiente</span>
          {% elif p.estado == 'en_produccion' %}<span class="badge badge-blue">En producción</span>
          {% elif p.estado == 'en_transito' %}<span class="badge badge-yellow">En tránsito</span>
          {% elif p.estado == 'recibido' %}<span class="badge badge-green">Recibido</span>
          {% elif p.estado == 'cancelado' %}<span class="badge badge-red">Cancelado</span>
          {% endif %}
        </td>
        <td>
          {% if p.albaran_numero %}
          <a href="/albaran/{{ p.albaran_id }}" style="font-family:var(--mono);font-size:.62rem;color:var(--green);text-decoration:none">
            {{ p.albaran_numero }} →
          </a>
          {% else %}
          <span style="color:var(--muted);font-size:.7rem">—</span>
          {% endif %}
        </td>
        <td><a href="/pedido/{{ p.id }}/detalle" class="btn btn-sm">Ver →</a></td>
      </tr>
      {% else %}
      <tr><td colspan="11" class="empty">No hay pedidos todavía</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
function aplicarFiltros() {
  const estado = document.getElementById('filtro-estado').value.toLowerCase();
  const proveedor = document.getElementById('filtro-proveedor').value.toLowerCase();
  const cliente = document.getElementById('filtro-cliente').value.toLowerCase();
  const proyecto = document.getElementById('filtro-proyecto').value.toLowerCase();
  
  let visibles = 0;
  document.querySelectorAll('#tabla-pedidos tbody tr[data-estado]').forEach(r => {
    const cumple = 
      (!estado || r.dataset.estado === estado) &&
      (!proveedor || r.dataset.proveedor.toLowerCase().includes(proveedor)) &&
      (!cliente || r.dataset.cliente.toLowerCase().includes(cliente)) &&
      (!proyecto || r.dataset.proyecto.toLowerCase().includes(proyecto));
    
    r.style.display = cumple ? '' : 'none';
    if (cumple) visibles++;
  });
  
  document.getElementById('contador-filtrados').textContent = 
    (estado || proveedor || cliente || proyecto) ? `${visibles} pedidos mostrados` : '';
}

function limpiarFiltros() {
  document.getElementById('filtro-estado').value = '';
  document.getElementById('filtro-proveedor').value = '';
  document.getElementById('filtro-cliente').value = '';
  document.getElementById('filtro-proyecto').value = '';
  aplicarFiltros();
}
</script>
{% endblock %}