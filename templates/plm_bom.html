{% extends "base.html" %}
{% block title %}— BOM {{ bom.nombre }}{% endblock %}

{% block topbar %}
<div style="display:flex;align-items:center;gap:1rem;flex:1">
  <a href="/plm" style="font-family:var(--mono);font-size:.55rem;color:var(--muted);text-decoration:none;letter-spacing:.1em">← PLM</a>
  <span style="color:var(--border)">|</span>
  <span style="font-family:var(--display);font-size:1.2rem;color:#fff">BOM — {{ bom.nombre }}</span>
  <span class="estado-badge estado-{{ bom.estado }}">{{ bom.estado }}</span>
</div>
<div style="display:flex;gap:.5rem">
  <form method="POST" action="/plm/bom/{{ bom.id }}/estado" style="display:flex;gap:.25rem">
    {% for est in ['borrador','revision','aprobado','liberado'] %}
    <button type="submit" name="estado" value="{{ est }}"
      class="btn-ghost" style="font-size:.55rem;padding:.3rem .6rem;{% if bom.estado==est %}border-color:var(--accent);color:var(--accent){% endif %}">
      {{ est.upper() }}
    </button>
    {% endfor %}
  </form>
  <button onclick="document.getElementById('modal-linea').style.display='flex'" class="btn-accent">+ LÍNEA</button>
</div>
{% endblock %}

{% block content %}
<style>
.estado-badge{display:inline-block;padding:.15rem .5rem;font-family:var(--mono);font-size:.5rem;letter-spacing:.1em;text-transform:uppercase;border-radius:2px}
.estado-borrador{background:rgba(85,85,85,.15);color:#888;border:1px solid rgba(85,85,85,.3)}
.estado-revision{background:rgba(243,156,18,.15);color:#f39c12;border:1px solid rgba(243,156,18,.3)}
.estado-aprobado{background:rgba(46,204,113,.15);color:#2ecc71;border:1px solid rgba(46,204,113,.3)}
.estado-liberado{background:rgba(155,89,182,.15);color:#9b59b6;border:1px solid rgba(155,89,182,.3)}
.bom-table{width:100%;border-collapse:collapse;font-size:.78rem}
.bom-table th{font-family:var(--mono);font-size:.48rem;letter-spacing:.15em;color:var(--muted);text-transform:uppercase;padding:.5rem .75rem;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap}
.bom-table td{padding:.55rem .75rem;border-bottom:1px solid var(--border);vertical-align:middle}
.bom-table tr:hover td{background:rgba(255,255,255,.02)}
.bom-info{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1.25rem}
.bom-info-card{background:var(--card);border:1px solid var(--border);padding:.75rem 1rem}
.bom-info-lbl{font-family:var(--mono);font-size:.45rem;letter-spacing:.15em;color:var(--muted);text-transform:uppercase;margin-bottom:.25rem}
.bom-info-val{font-size:.8rem;color:var(--text)}
</style>

<div class="bom-info">
  <div class="bom-info-card">
    <div class="bom-info-lbl">Proyecto</div>
    <div class="bom-info-val">{{ bom.proyecto_nombre or '—' }}</div>
  </div>
  <div class="bom-info-card">
    <div class="bom-info-lbl">Total líneas</div>
    <div class="bom-info-val" style="font-family:var(--display);font-size:1.5rem;color:var(--accent2)">{{ lineas|length }}</div>
  </div>
  <div class="bom-info-card">
    <div class="bom-info-lbl">Creado</div>
    <div class="bom-info-val" style="font-family:var(--mono);font-size:.65rem;color:var(--muted2)">{{ bom.creado[:10] }}</div>
  </div>
</div>

{% if bom.descripcion %}
<div style="padding:.75rem 1rem;background:var(--card);border:1px solid var(--border);border-left:3px solid var(--accent);font-size:.75rem;color:var(--muted2);margin-bottom:1.25rem">{{ bom.descripcion }}</div>
{% endif %}

<div style="background:var(--card);border:1px solid var(--border)">
  {% if lineas %}
  <table class="bom-table">
    <thead>
      <tr>
        <th style="width:50px">Pos</th>
        <th>Código</th>
        <th>Descripción</th>
        <th style="width:70px;text-align:right">Cantidad</th>
        <th style="width:50px">Ud.</th>
        <th>Material</th>
        <th>Proveedor</th>
        <th>Doc CAD</th>
        <th>Notas</th>
        <th style="width:40px"></th>
      </tr>
    </thead>
    <tbody>
      {% for l in lineas %}
      <tr>
        <td style="font-family:var(--mono);font-size:.6rem;color:var(--muted)">{{ l.pos }}</td>
        <td style="font-family:var(--mono);font-size:.6rem;color:var(--accent)">{{ l.codigo or '—' }}</td>
        <td style="font-weight:500">{{ l.descripcion }}</td>
        <td style="text-align:right;font-family:var(--mono);font-size:.7rem;color:var(--accent2)">{{ l.cantidad }}</td>
        <td style="font-family:var(--mono);font-size:.55rem;color:var(--muted)">{{ l.unidad }}</td>
        <td style="color:var(--muted2);font-size:.72rem">{{ l.material or '—' }}</td>
        <td style="color:var(--muted2);font-size:.72rem">{{ l.proveedor or '—' }}</td>
        <td>
          {% if l.doc_codigo %}
          <a href="/plm/documento/{{ l.documento_id }}" style="font-family:var(--mono);font-size:.5rem;color:var(--accent);text-decoration:none">{{ l.doc_codigo }}</a>
          {% else %}—{% endif %}
        </td>
        <td style="color:var(--muted2);font-size:.68rem">{{ l.notas or '' }}</td>
        <td>
          <form method="POST" action="/plm/bom/{{ bom.id }}/linea/{{ l.id }}/delete">
            <button type="submit" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:.75rem;opacity:.5;transition:opacity .15s" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=.5">✕</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div style="text-align:center;padding:3rem;color:var(--muted)">
    <div style="font-family:var(--display);font-size:1.8rem;margin-bottom:.5rem">BOM VACÍA</div>
    <div style="font-size:.75rem">Añade la primera línea de materiales</div>
  </div>
  {% endif %}
</div>

<!-- MODAL NUEVA LÍNEA BOM -->
<div id="modal-linea" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center">
  <div style="background:var(--panel);border:1px solid var(--border);padding:2rem;width:560px;max-width:95vw;max-height:90vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
      <span style="font-family:var(--display);font-size:1.3rem;color:#fff">AÑADIR LÍNEA</span>
      <button onclick="document.getElementById('modal-linea').style.display='none'" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.2rem">✕</button>
    </div>
    <form method="POST" action="/plm/bom/{{ bom.id }}/linea">
      <div class="form-grid cols-2">
        <div class="form-field">
          <label class="form-label">Código</label>
          <input name="codigo" class="form-input" placeholder="Ej: PZA-001">
        </div>
        <div class="form-field">
          <label class="form-label">Doc CAD vinculado</label>
          <select name="documento_id" class="form-select">
            <option value="">Sin vincular</option>
            {% for d in docs %}<option value="{{ d.id }}">{{ d.codigo }} — {{ d.nombre[:30] }}</option>{% endfor %}
          </select>
        </div>
      </div>
      <div class="form-field">
        <label class="form-label">Descripción *</label>
        <input name="descripcion" class="form-input" placeholder="Descripción del componente" required>
      </div>
      <div class="form-grid cols-3">
        <div class="form-field">
          <label class="form-label">Cantidad *</label>
          <input name="cantidad" type="number" step="0.001" class="form-input" value="1" required>
        </div>
        <div class="form-field">
          <label class="form-label">Unidad</label>
          <select name="unidad" class="form-select">
            <option value="ud">ud</option>
            <option value="m">m</option>
            <option value="kg">kg</option>
            <option value="mm">mm</option>
            <option value="cm2">cm²</option>
            <option value="l">l</option>
          </select>
        </div>
        <div class="form-field">
          <label class="form-label">Material</label>
          <input name="material" class="form-input" placeholder="Acero, Aluminio...">
        </div>
      </div>
      <div class="form-grid cols-2">
        <div class="form-field">
          <label class="form-label">Proveedor</label>
          <input name="proveedor" class="form-input" placeholder="Proveedor o referencia">
        </div>
        <div class="form-field">
          <label class="form-label">Notas</label>
          <input name="notas" class="form-input" placeholder="Notas adicionales">
        </div>
      </div>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem">
        <button type="button" onclick="document.getElementById('modal-linea').style.display='none'" class="btn-ghost">Cancelar</button>
        <button type="submit" class="btn-accent">AÑADIR LÍNEA</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
